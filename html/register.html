<!DOCTYPE html>
<html lang="zh-cn">
<head>
<title>CoCo-注册</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- css -->
<link href="../css/base.min.css" rel="stylesheet">
<link href="../css/project.min.css" rel="stylesheet">
<link href="../css/auth.css" rel="stylesheet">
<link href="../css/Material_Icons.css" rel="stylesheet">
</head>
<body class="page-brand">
<div class="authpage">
  <div class="container">
    <div class="auth-main auth-row auth-col-one" id="demo">
      <div class="auth-top auth-row" id="test"> <a class="boardtop-left" href="../index.html">
        <div>首 页</div>
        </a>
        <div class="auth-logo"> <img src="../images/ic_login.jpg" alt=""> </div>
        <a href="../html/Login.html" class="boardtop-right">
        <div>登录</div>
        </a> </div>
      <div class="btn-auth auth-row" id="refresh" style="display: none">
        <button id="refreshBtn" type="submit" class="btn btn-block btn-brand waves-attach waves-light"> 重新输入QQ号 </button>
      </div>
      <div class="btn-auth auth-row" id="reSendSecurityCodeBtn" style="display: none">
        <button id="reSendSecurityCode" type="submit" class="btn btn-block btn-brand waves-attach waves-light"> 重新发送验证码 </button>
      </div>
      <div class="auth-row">
        <div class="form-group-label auth-row row-login">
          <label class="floating-label" for="qqNumber">QQ号</label>
          <input class="form-control maxwidth-auth" id="qqFristNumber" type="text" name="qqNumber" oninput="value=value.replace(/[^\d]/g,'')">
        </div>
      </div>
      <div class="auth-row" id="qqInput">
        <div class="form-group-label auth-row row-login">
          <label class="floating-label" for="qqNumber">确认QQ号</label>
          <input class="form-control maxwidth-auth" id="qqSecondNumber" type="text" name="qqNumber" oninput="value=value.replace(/[^\d]/g,'')">
        </div>
      </div>
      <div class="auth-row" id="securityCodeInput" style="display: none">
        <div class="form-group-label auth-row row-login">
          <label class="floating-label" for="securityCode">验证码(6位)</label>
          <input class="form-control maxwidth-auth" id="securityCode" type="text" name="securityCode" oninput="value=value.replace(/[^\d]/g,'')">
        </div>
      </div>
      <div class="auth-row" style="display: none" id="nameInput">
        <div class="form-group-label auth-row row-login">
          <label class="floating-label" for="name">用户名（6-15位）</label>
          <input class="form-control maxwidth-auth" id="name" type="text" name="Name">
        </div>
      </div>
      <div class="auth-row" id="firstPasswordInput" style="display: none">
        <div class="form-group-label auth-row row-login">
          <label class="floating-label" for="passwd">密码（8-16位）</label>
          <input class="form-control maxwidth-auth" id="firstPasswd" type="password" name="Password">
        </div>
      </div>
      <div class="auth-row" id="secondPasswordInput" style="display: none">
        <div class="form-group-label auth-row row-login">
          <label class="floating-label" for="passwd">确认密码</label>
          <input class="form-control maxwidth-auth" id="secondPasswd" type="password" name="Password">
        </div>
      </div>
      <div class="btn-auth auth-row" id="sendSecurityCodeBtn">
        <button id="sendSecurityCode" type="submit" class="btn btn-block btn-brand waves-attach waves-light"> 点击发送验证码 </button>
      </div>
      <div class="btn-auth auth-row" id="verifySecurityCodeAndName" style="display: none">
        <button id="verifySecurityCodeAndNameBtn" type="submit" class="btn btn-block btn-brand waves-attach waves-light"> 验证 </button>
      </div>
      <div class="btn-auth auth-row" id="registerBtn" style="display: none">
        <button id="register" type="submit" class="btn btn-block btn-brand waves-attach waves-light"> 注册 </button>
      </div>
      <br>
    </div>
  </div>
</div>
<div aria-hidden="true" class="modal modal-va-middle fade" id="result" role="dialog" tabindex="-1">
  <div class="modal-dialog modal-xs">
    <div class="modal-content">
      <div class="modal-inner">
        <p class="h5 margin-top-sm text-black-hint" id="msg"></p>
      </div>
      <div class="modal-footer">
        <p class="text-right">
          <button class="btn btn-flat btn-brand-accent waves-attach" data-dismiss="modal" type="button" id="result_ok">知道了</button>
        </p>
      </div>
    </div>
  </div>
</div>
<canvas id="c_n1"></canvas>
<footer class="ui-footer">
  <div class="container">
    <marquee>
    &copy;2019 CoCo
    </marquee>
  </div>
</footer>

<!-- js --> 
<script src="../js/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript" src="../js/judge.js"></script>
<script src="../js/gt.js" type="text/javascript"></script> 
<script src="../js/base.min.js" type="text/javascript"></script> 
<script src="../js/project.min.js" type="text/javascript"></script>
<script src="../js/md5.js" type="text/javascript"></script> 
<script src="../js/canvas-nest.js" type="text/javascript"></script>
<script src="../js/qrcode.min.js" type="text/javascript"></script>
</body>
</html>
<script>
	$(document).ready(function () {
        $("#sendSecurityCode").click(function(){
            sendSecurityCode();    
        });
        
        $("#register").click(function () {
            register();
        });
        
        $("#reSendSecurityCode").click(function(){
            reSendSecurityCode();
        });
        
        $("#verifySecurityCodeAndName").click(function(){
            verifySecurityCodeAndName();
        });

        $("#refreshBtn").click(function() {
            location.reload();
        });
        
        function sendSecurityCode(){
            //获取两次输入的QQ号的值
            var qqF = document.getElementById("qqFristNumber").value;
            var qqS = document.getElementById("qqSecondNumber").value;
            //验证两次QQ号输入是否相同
            if(qqF.length == qqS.length && qqF == qqS){
                //验证QQ号长度是否在合法范围内
                if(qqF.length < 5 || qqF.length > 11){
                    $("#result").modal();
                    $("#msg").html("！！！QQ号格式不正确，请检查后输入正确的QQ号！！！");
                }
                //QQ号输入合法，发送QQ号到后台，确认QQ号是否已被注册过，若没有被注册过，则向该邮箱发送验证码，若已被注册则提示该QQ号已被注册，请直接登录，若忘记密码请找回密码
                else{
					var json = {
						"qq": qqF
					};
                    $.ajax({
                        type: "POST",
                        url: "http://120.78.64.17:8080/TTMS_bs1.0/up/Securityqqtocode",
						async: true,
						data: JSON.stringify(json),
                        dataType: 'json',
                        contentType: 'application/json',
						
					xhrFields:{
						withCredentials: true
					},
                        success: function(data){
                            if(data.qqState == true){
                                document.getElementById("qqFristNumber").disabled = true;
                                document.getElementById("qqSecondNumber").disabled = true;
                                $("#refresh").show();
                                $("#reSendSecurityCodeBtn").show();
                                countDown();
								$("#qqInput").hide();
                                $("#securityCodeInput").show();
                                $("#nameInput").show();
                                $("#sendSecurityCodeBtn").hide();
                                $("#verifySecurityCodeAndName").show();
								$("#result").modal();
                                $("#msg").html("！！！验证码发送成功，如未收到请查看垃圾邮件！！！");
                            }else{
								$("#result").modal();
                                $("#msg").html("！！！该QQ号已被注册，请直接登录，若忘记密码请找回密码！！！");
                            }
                        }
                    })
                }
            }else{
                $("#result").modal();
                $("#msg").html("！！！两次QQ号输入不一致,请检查后重新输入！！！");
            }
        }
        
        function register() {
            document.getElementById("register").disabled = true;

			var firstPasswd = document.getElementById("firstPasswd").value;
			var secondPasswd = document.getElementById("secondPasswd").value;
            
            //开始验证注册信息格式
            //验证两次输入的密码是否一样
			if(firstPasswd.length == secondPasswd.length && firstPasswd == secondPasswd){
				//验证密码长度是否合法
                if(firstPasswd.length < 8 || firstPasswd.length > 16){
                    //密码长度过短
                    if(firstPasswd.length < 8){
                        $("#result").modal();
                        $("#msg").html("！！！输入的密码过短，请重新输入！！！");
                    }
                    //密码长度过长
                    else{
                        $("#result").modal();
                        $("#msg").html("！！！输入的密码过短，请重新输入！！！");
                    }
                }
                //密码合法
                else{
                    //
					var qq = document.getElementById("qqFristNumber").value;
					var name = document.getElementById("name").value;
					var hash = hex_md5(firstPasswd);
					var json = {
						"userqq": qq,
						"username": name,
						"userpassword": hash
					}
                    $.ajax({
                        type: "POST",
                        url: "http://120.78.64.17:8080/TTMS_bs1.0/up/register",
                        dataType: "json",
                        data:JSON.stringify(json),
						async: true,
                		contentType: 'application/json',
						xhrFields:{
							withCredentials: true
						},
                        success: function(data){
                           if(data.registerState == true){
                                $("#result").modal();
                                $("#msg").html("！！！注册成功，请登录！！！");
                               window.setTimeout(function(){
                                   window.location = "./Login.html"
                               },1200);
                           }else{
                                $("#result").modal();
                                $("#msg").html("！！！注册失败，请重试！！！");
                           }
                        }
                    })
                }
			}
            //密码长度不一致
            else{
				$("#result").modal();
				$("#msg").html("！！！两次密码输入不一致,请重新输入！！！");
			}
            document.getElementById("register").disabled = false;
	   }
        
        function verifySecurityCodeAndName(){
            //
            var securityCode = document.getElementById("securityCode").value;
            //
            var name = document.getElementById("name").value;
            //开始验证注册信息格式
            //用户名是否为空
			if(name.length == 0){
				$("#result").modal();
                $("#msg").html("！！！请输入用户名！！！");
			}
            //用户名长度是否在范围内
            else if(name.length < 6 || name.length > 15){
                //用户名过短
				if(name.length < 6){
					$("#result").modal();
                	$("#msg").html("！！！输入的用户名过短，请重新输入！！！");
				}
                //用户名过长
                else{
					$("#result").modal();
                	$("#msg").html("！！！输入的用户名过长，请重新输入！！！");
				}
			}
            //用户名合法，开始进行验证码校验
            else{
                if(securityCode.length == 0){
                    $("#result").modal();
                    $("#msg").html("！！！请输入验证码！！！");
                }else if(securityCode.length != 6){
                    $("#result").modal();
                    $("#msg").html("！！！请输入格式正确验证码！！！");
				}
                else{
					var json = {
						"securityCode":securityCode,
						"username":name
					};
                $.ajax({
                    type: "POST",
                    url: "http://120.78.64.17:8080/TTMS_bs1.0/up/Senameandcode",
					async: true,
					data: JSON.stringify(json),
					dataType: "json",
                	contentType: 'application/json',
					xhrFields:{
						withCredentials: true
					},
                    success: function(data){
                        if(data.nameState == true && data.securityCodeState == true){
                            $("#refresh").hide();
                            $("#reSendSecurityCodeBtn").hide();
                            document.getElementById("securityCode").disabled = true;
                            $("#securityCodeInput").hide();
                            document.getElementById("name").disabled = true
                            $("#firstPasswordInput").show();
                            $("#secondPasswordInput").show();
                            $("#verifySecurityCodeAndName").hide();
                            $("#registerBtn").show();      
                        }
                        else{
                            if(data.nameState == false && data.securityCodeState == false){
                                $("#result").modal();
                                $("#msg").html("！！！该用户名已被注册，验证码也输入错误！！！");
                            }
                            else{
                                if(data.nameState == true){
                                    $("#result").modal();
                                    $("#msg").html("！！！验证码输入错误！！！");
                                }else{
                                    $("#result").modal();
                                    $("#msg").html("！！！该用户名已被注册！！！");
                                }   
                            }
                        }
                    }
                })
                }
            }
        }
        
        function reSendSecurityCode(){
			countDown();
            var qq = document.getElementById("qqFristNumber").value;
            var json = {
				"qq":qq
			};
            $.ajax({
                type: "POST",
                url: "http://120.78.64.17:8080/TTMS_bs1.0/up/Securityqqtocode",
				async: true,
				data: JSON.stringify(json),
				dataType: "json",
                contentType: 'application/json',
				xhrFields:{
					withCredentials: true
				},
                success: function(data){
                    if(data.qqState == true){
                        $("#result").modal();
                        $("#msg").html("！！！验证码发送成功，请注意查收邮箱！！！");
                    }else{
                        $("#result").modal();
                        $("#msg").html("！！！验证码发送失败，请稍后再试！！！");
                    }
                }
            });
        };
        
        //重新发送验证码间隔时长
        var time = 30;
        //重新发送验证码倒计时
        function countDown(){
            if(time == 0){
                document.getElementById("reSendSecurityCode").disabled = false;
                document.getElementById("reSendSecurityCode").innerHTML = "重新发送验证码";
                time = 30;
                return;
            }else{
                document.getElementById("reSendSecurityCode").disabled = true;
                document.getElementById("reSendSecurityCode").innerHTML = "重新发送验证码(" + time +")";
                time--;
            }
            setTimeout(function(){
                countDown();
            },1000);
        }
        
        $('div.modal').on('shown.bs.modal', function () {
            $("div.gt_slider_knob").hide();
        });

        $('div.modal').on('hidden.bs.modal', function () {
            $("div.gt_slider_knob").show();
        });
	});
</script>